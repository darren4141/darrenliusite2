<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Project 7</title>
  <link rel="stylesheet" href="projectstylesheet.css">
  <link rel="stylesheet" href="pcbviewer.css" />
  <script type="module" src="kicanvas.js"></script>
  <script src="pcbviewer.js" defer></script>

  <style>
    #model-viewer {
      width: 80%;
      height: 500px;
      margin: 0 auto;
      display: block;
      border: 1px solid #ccc;
    }
  </style>
</head>

<body>
  <div class="project-content">
    <a href="index.html" class="close-button">&times;</a>
    <div class="project-text">
      <h1>TED Hardware + Firmware Interface</h1>
      <h2 class="subtitle">2025 | In Progress</h2>
      <p>TED is a social robotics product under development that aims to care for its user through AI driven audio +
        video processing and features hardware peripherals such as motors and heart rate monitoring sensors.</p>
      <p>I am designing and implementing the hardware and firmware stack for this project which is as follows:</p>

      <img src="project8/hw_sw_stack.png" alt="hw_sw_stack" , width="80%">

      <h2>Hardware</h2>
      <img src="project8/board_front.jpg" alt="board_front" , width="32%" , display="inline">
      <img src="project8/board_back.jpg" alt="board_back" , width="33%" , display="inline">
      <img src="project8/board_back_w_module.jpg" alt="board_back_w_module" , width="34%" , display="inline">
      <p>The project utilizes the Raspberry Pi Compute Module, which is a version of the RPi 4 with an emphasis on small
        form factor for custom use in embedded projects. My interface board for the CM4 allows for the usage of various
        hardware peripherals, and also manages power.</p>
      <!-- RPI CM4 interface board -->
      <div class="pcb-viewer">
        <h2>RPI CM4 interface board</h2>
        <div class="image-container">
          <img id="viewer5" src="PCBanimation/CM4_Interface_Board/board render0.webp" alt="CM4 Viewer" width="80%"
            display="block" margin-left="auto">
        </div>
        <button class="view-btn" onclick="resetViewer(0)">Reset View</button>
        <button class="view-btn" id="toggle-rotate-5" onclick="toggleRotation(0)">Auto Rotate</button>
        <button class="view-btn" onclick="showModal('modal-cm4-int-schem')">View Schematic</button>
        <button class="view-btn" onclick="showModal('modal-cm4-int-pcb')">View PCB Layout</button>

        <h3>Features:</h3>
        <p>- Power management: Two isolated buck regulators (for MCU/peripherals), 3.3V LDO, USB-C Li-ion battery
          recharging, current sense and low battery detection, ESD and reverse polarity protection</p>
        <p>- Shared I2C bus featuring an integrated IMU, current sense IC, heart rate/blood oxygen monitors</p>
        <p>- Microphone and speaker I/O over I2S</p>
        <p>- 22-pin interface camera support with impedance controlled differential pairs</p>
      </div>

      <h3>Heartbeat sensor integration</h3>
      <p>The heartbeat sensor subsystem features numerous threads that allow for continuous reading and processing of
        raw data. The multithreaded signal processing sequence is described below:</p>
      <img src="project8/irled_threads_diagram.png" alt="irled_threads_diagram" , width="80%">
      <p>One of the more involved aspects of this process was extracting heartbeat signal from raw MAX30102 sensor
        readings.</p>

      <img src="project8/raw_readings_vs_time.png" alt="raw_readings_vs_time" , width="75%">

      <p>As you can see, the raw readings have lots of noise and have to go through numerous signal processing steps in
        order to extract proper
        heartbeat data. The steps are as follows:</p>

      <h4>Step 1: Remove DC component of data with an exponential moving average (EMA)</h4>
      <p>Raw readings have a DC component caused my factors such as finger pressure, ambient light, and finger
        placement, and an AC component which captures the actual heartbeat. This DC component is isolated using an
        expected moving average formula, and is subtracted from the original signal, leaving the desired AC component of
        the signal.
      </p>
      <img src="project8/raw_readings_and_DC.png" alt="raw_readings_and_DC" , width="75%">
      <img src="project8/AC_readings_vs_time.png" alt="AC_readings_vs_time" , width="75%">
      <h4>Step 2: Filter out unwanted frequencies using a band-pass filter (BPF)</h4>
      <p>Next, unwanted frequencies, mainly high frequency spikes are filtered out using a band pass filter. I chose an
        alpha value (0.04 * 100 samples per second = 0.25s = 250BPM) to ensure I was only filtering out frequencies
        well outside the range of typical heart rates.</p>
      <img src="project8/BPF_readings_vs_time.png" alt="BPF_readings_vs_time" , width="75%">
      <h4>Step 3: Smooth out function, generate a threshold function, detect local maximums</h4>
      <p>After applying some additional smoothing to the filtered function, I detect heartbeats by generating a second
        "threshold" function, which is a more dramatically smoothed version of the function. If a given point is a local
        maximum and is over the threshold, it is deemed a heartbeat.</p>
      <img src="project8/heartbeats_vs_time.png" alt="heartbeats_vs_time" , width="75%">
    </div>

    <div id="modal-cm4-int-schem" class="modal">
      <div class="modal-content"><kicanvas-embed controls="full" theme="kicad"><kicanvas-source
            src="schematics/PiComputeModuleBreakout.kicad_sch"></kicanvas-source></kicanvas-embed></div>
    </div>
    <div id="modal-cm4-int-pcb" class="modal">
      <div class="modal-content"><kicanvas-embed controls="full" theme="kicad"><kicanvas-source
            src="layouts/PiComputeModuleBreakout.kicad_pcb"></kicanvas-source></kicanvas-embed></div>
    </div>

  </div>
</body>

</html>